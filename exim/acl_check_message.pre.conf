# Spamtroll Anti-Spam ACL for Exim
# This file is auto-generated by Spamtroll DirectAdmin plugin
# Location: /etc/exim.acl_check_message.pre.conf
#
# DirectAdmin includes this file automatically in the DATA ACL.
# No modifications to the main Exim configuration are required.
#
# How it works:
# 1. For each incoming email, Exim runs /usr/local/bin/spamtroll-check
# 2. The script sends the email content to Spamtroll API
# 3. Based on the API response, a header is added or email is rejected

# Skip checking for authenticated users (outgoing mail)
accept
  authenticated = *

# Skip checking for local deliveries from trusted sources
accept
  hosts = +relay_from_hosts

# Check incoming email with Spamtroll API
# Pass message info via environment variables and headers via command line
warn
  set acl_m_spamtroll_check = ${run{/usr/local/bin/spamtroll-check \
    "$sender_host_address" \
    "$sender_address" \
    "${sg{$h_from:}{\\n}{}}" \
    "${sg{$h_to:}{\\n}{}}" \
    "${sg{$h_subject:}{\\n}{}}" \
    "${sg{$h_message-id:}{\\n}{}}" \
    "${sg{${substr{0}{50000}{$message_body}}}{\\n}{ }}"}{$runrc}{2}}

# Exit code 2 (error) = no match for conditions below = implicit accept (fail-open)

# Reject if Spamtroll detected spam (exit code 1)
deny
  condition = ${if eq{$acl_m_spamtroll_check}{1}{yes}{no}}
  message = 550 Message rejected: spam detected by Spamtroll anti-spam system
  log_message = Spamtroll BLOCKED: from=<$sender_address> ip=$sender_host_address

# Add header for emails that passed check
warn
  condition = ${if eq{$acl_m_spamtroll_check}{0}{yes}{no}}
  add_header = X-Spamtroll-Status: clean
